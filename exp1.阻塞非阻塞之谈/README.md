# IO概念
阻塞|非阻塞：用户态和内核态的交互方式
同步|异步：用户态调用内核态的操作方式

## 什么是阻塞IO？
用户态对内核态发起了系统调用，系统调用等待数据处理结束然后拷贝到用户态。然后用户态继续处理。
比如在阻塞模式下`socket`的`accept`和`read`操作。

```php
socket_accept($fd);
```

## 什么是非阻塞IO？
用户态对内核态发起了系统调用，但是内核态会立即返回用户态一个结果。然后用户态下继续执行。
一般这种情况都会在一个循环内，等待下次循环后继续对内核态发起系统调用。

```php
$client = [];
socket_set_nonblock($fd);
while(true) {
    if($cfd = socket_accept($fd)) {
        $client[$cfd] = $cfd;
    }
    foreach($client as $c) {
        //...
    }
}
```

## 什么是同步？
用户态下对内核态发起一个IO请求，需要等待IO处理结束之后返回结果给用户态才能继续执行。
如对MySQL发起一个query，等待查询的结果后再继续处理结果。

```php
$data = $db->query($sql); //等待MySQL的查询结果返回后才继续执行代码
foreach($data as $d) {
    //do something
}
```
执行MySQL查询时，在进行IO操作。此时的CPU处于闲置状态。

## 什么是异步？
用户态下对内核发起一个IO请求之后，内核会立即返回给用户态然后用户态下的代码继续执行。

```php
Co\run(function() {
    go(function(){
        $data = $db->query($sql); 
        foreach($data as $d) {
            //do something
        }
    });
    //do something
});
```
异步执行在事件发生后会调用回调函数处理。在go的子协程内发生IO请求之后，会立即触发协程调度让出子协程的CPU继续执行下面的代码。这个时候的IO操作会被注册到IO多路复用，等数据处理完成之后会继续执行子协程。

## 什么是IO多路复用？
有在文章说被称为是`异步阻塞`。但是我在我的代码内是置成了非阻塞模式啊，那不就成了`异步非阻塞`了吗？
现在讲讲`socket_select`函数。在非IO多路复用的情况下，如果一个服务器想要同时服务多个客户端的时候就会显得很难，比如在阻塞模式下如果等待一个客户端的read操作，那么就无法响应其他的客户端发送的数据了。即使切成了非阻塞模式，也需要一直轮询每个客户端，询问他们是否发送了数据。但是使用了`select`之后，在阻塞模式下只有事件触发了的fd才会被返回。非阻塞模式下如果没有事件，主进程还可以自己去做一些其他的事情。
举个例子：银行的工作人员，好比是一个主进程。前来办业务的顾客，好比是客户端。

